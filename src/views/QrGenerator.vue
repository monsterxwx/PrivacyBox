<template>
  <div class="min-h-screen bg-slate-50 relative overflow-hidden font-sans selection:bg-fuchsia-100">
    <!-- ================= èƒŒæ™¯ç‰¹æ•ˆ ================= -->
    <div class="absolute inset-0 z-0 opacity-[0.4]" style="background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 32px 32px;" />
    <!-- å·¦ä¸Šè§’ç´«çº¢ -->
    <div class="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-fuchsia-300 rounded-full mix-blend-multiply filter blur-[128px] opacity-40 animate-blob" />
    <!-- å³ä¸‹è§’é’è‰² -->
    <div class="absolute bottom-[-10%] right-[-10%] w-[500px] h-[500px] bg-cyan-300 rounded-full mix-blend-multiply filter blur-[128px] opacity-40 animate-blob animation-delay-2000" />
    <!-- ä¸­é—´ç´«è‰² -->
    <div class="absolute top-[30%] left-[20%] w-[400px] h-[400px] bg-violet-300 rounded-full mix-blend-multiply filter blur-[100px] opacity-30 animate-blob animation-delay-4000" />

    <!-- ================= å†…å®¹åŒºåŸŸ ================= -->
    <div class="relative z-10 max-w-6xl mx-auto px-4 sm:px-6 py-12">
      <!-- å¤´éƒ¨ -->
      <div class="text-center mb-12">
        <RouterLink to="/" class="inline-flex items-center gap-1 text-sm font-medium text-slate-500 hover:text-fuchsia-600 mb-4 transition-colors">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          ><path d="m15 18-6-6 6-6" /></svg>
          è¿”å›é¦–é¡µ
        </RouterLink>
        <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 mb-4">
          <span class="text-transparent bg-clip-text bg-gradient-to-r from-fuchsia-600 to-cyan-600">äºŒç»´ç ä¸ªæ€§åŒ–</span>
        </h1>
        <p class="text-slate-600 max-w-2xl mx-auto">
          ä¸ä»…ä»…æ˜¯é»‘ç™½æ–¹å—ã€‚æ”¯æŒè‡ªå®šä¹‰é¢œè‰²ã€åµŒå…¥ Logo å›¾æ ‡ï¼Œè®©æ‚¨çš„äºŒç»´ç è„±é¢–è€Œå‡ºã€‚
        </p>
      </div>

      <!-- ä¸»ç•Œé¢ -->
      <div class="grid lg:grid-cols-12 gap-8 items-start">
        <!-- å·¦ä¾§ï¼šé…ç½®é¢æ¿ -->
        <div class="lg:col-span-5 flex flex-col gap-6">
          <div class="bg-white/80 backdrop-blur-xl rounded-3xl shadow-xl border border-white/50 p-6 md:p-8">
            <div class="flex items-center gap-2 mb-6">
              <div class="w-1 h-6 bg-fuchsia-500 rounded-full" />
              <h2 class="text-lg font-bold text-slate-800">
                ç”Ÿæˆè®¾ç½®
              </h2>
            </div>

            <!-- 1. å†…å®¹è¾“å…¥ -->
            <div class="mb-6">
              <label class="block text-sm font-medium text-slate-700 mb-2">äºŒç»´ç å†…å®¹ (æ–‡æœ¬/é“¾æ¥)</label>
              <textarea
                v-model="config.text"
                rows="3"
                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-800 focus:ring-2 focus:ring-fuchsia-500/20 focus:border-fuchsia-500 outline-none transition-all resize-none text-sm"
                placeholder="https://example.com"
              />
            </div>

            <!-- 2. å¤–è§‚æ ·å¼ -->
            <div class="space-y-5">
              <!-- é¢œè‰²è®¾ç½® -->
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs text-slate-500 mb-2">å‰æ™¯è‰² (ç ç‚¹)</label>
                  <div class="flex items-center gap-2 bg-slate-50 border border-slate-200 rounded-xl p-2 cursor-pointer hover:border-fuchsia-300 transition-colors relative">
                    <input type="color" v-model="config.darkColor" class="w-8 h-8 rounded border-none bg-transparent cursor-pointer">
                    <span class="text-xs font-mono text-slate-600 flex-1">{{ config.darkColor }}</span>
                  </div>
                </div>
                <div>
                  <label class="block text-xs text-slate-500 mb-2">èƒŒæ™¯è‰²</label>
                  <div class="flex items-center gap-2 bg-slate-50 border border-slate-200 rounded-xl p-2 cursor-pointer hover:border-fuchsia-300 transition-colors relative">
                    <input type="color" v-model="config.lightColor" class="w-8 h-8 rounded border-none bg-transparent cursor-pointer">
                    <span class="text-xs font-mono text-slate-600 flex-1">{{ config.lightColor }}</span>
                  </div>
                </div>
              </div>

              <!-- å®¹é”™ç‡ä¸è¾¹è· -->
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs text-slate-500 mb-2">å®¹é”™ç‡ (å»ºè®® High)</label>
                  <select v-model="config.errorLevel" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2.5 text-sm text-slate-700 outline-none focus:border-fuchsia-500">
                    <option value="L">
                      L (7%)
                    </option>
                    <option value="M">
                      M (15%)
                    </option>
                    <option value="Q">
                      Q (25%)
                    </option>
                    <option value="H">
                      H (30%) - æ¨è
                    </option>
                  </select>
                </div>
                <div>
                  <label class="block text-xs text-slate-500 mb-2">è¾¹è· (Margin)</label>
                  <select v-model.number="config.margin" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2.5 text-sm text-slate-700 outline-none focus:border-fuchsia-500">
                    <option :value="0">
                      æ— è¾¹è·
                    </option>
                    <option :value="1">
                      1x
                    </option>
                    <option :value="2">
                      2x
                    </option>
                    <option :value="4">
                      4x (é»˜è®¤)
                    </option>
                  </select>
                </div>
              </div>
            </div>

            <!-- 3. Logo è®¾ç½® -->
            <div class="mt-6 pt-6 border-t border-slate-100">
              <label class="block text-sm font-medium text-slate-700 mb-3 flex justify-between">
                <span>åµŒå…¥ Logo (ä¸­å¿ƒå›¾æ ‡)</span>
                <span v-if="logoUrl" @click="removeLogo" class="text-xs text-red-500 cursor-pointer hover:underline">ç§»é™¤ Logo</span>
              </label>

              <div
                v-if="!logoUrl"
                @click="triggerLogoUpload"
                class="border-2 border-dashed border-slate-300 rounded-xl bg-slate-50 p-4 text-center cursor-pointer hover:bg-fuchsia-50 hover:border-fuchsia-300 transition-all text-slate-500 hover:text-fuchsia-600"
              >
                <div class="text-2xl mb-1">
                  ğŸ–¼ï¸
                </div>
                <div class="text-xs">
                  ç‚¹å‡»ä¸Šä¼  Logo å›¾ç‰‡
                </div>
                <input
                  type="file"
                  ref="logoInput"
                  accept="image/*"
                  class="hidden"
                  @change="handleLogoChange"
                >
              </div>

              <div v-else class="flex items-center gap-4 bg-fuchsia-50 border border-fuchsia-100 rounded-xl p-3">
                <img :src="logoUrl" class="w-12 h-12 object-contain rounded-lg bg-white border border-slate-200 shadow-sm">
                <div class="flex-1">
                  <div class="text-xs text-slate-500 mb-1">
                    Logo å¤§å° ({{ config.logoSize }}%)
                  </div>
                  <input
                    type="range"
                    v-model.number="config.logoSize"
                    min="10"
                    max="30"
                    step="1"
                    class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-fuchsia-500"
                  >
                </div>
              </div>
              <p class="text-[10px] text-slate-400 mt-2">
                æç¤ºï¼šåµŒå…¥ Logo æ—¶å»ºè®®å°†å®¹é”™ç‡è®¾ç½®ä¸º H (30%) ä»¥ç¡®ä¿å¯æ‰«æã€‚
              </p>
            </div>
          </div>
        </div>

        <!-- å³ä¾§ï¼šé¢„è§ˆä¸ä¸‹è½½ -->
        <div class="lg:col-span-7 sticky top-8">
          <div class="bg-white/70 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/50 p-6 md:p-10 flex flex-col items-center justify-center min-h-[500px] relative">
            <!-- ç”»å¸ƒå®¹å™¨ -->
            <div class="flex-1 flex items-center justify-center w-full">
              <div
                class="relative group shadow-2xl rounded-lg overflow-hidden transition-transform duration-300 hover:scale-105 bg-white w-full max-w-[280px] sm:max-w-[320px] md:max-w-[360px] lg:max-w-[400px] aspect-square"
              >
                <img
                  v-if="previewUrl"
                  :src="previewUrl"
                  class="w-full h-full object-contain"
                  alt="äºŒç»´ç é¢„è§ˆ"
                >
                <!-- åŠ ä¸ª loading çŠ¶æ€æˆ–å ä½ç¬¦ -->
                <div v-else class="text-slate-300 text-xs">
                  ç”Ÿæˆä¸­...
                </div>
              </div>
            </div>

            <!-- æŒ‰é’®ç»„ -->
            <div class="w-full grid grid-cols-1 gap-4 mt-10 max-w-xs mx-auto">
              <button
                @click="download"
                class="flex items-center justify-center gap-2 py-3.5 bg-gradient-to-r from-fuchsia-600 to-cyan-600 text-white font-bold rounded-xl shadow-lg shadow-fuchsia-500/30 hover:shadow-fuchsia-500/50 hover:-translate-y-0.5 transition-all"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                ><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line
                  x1="12"
                  y1="15"
                  x2="12"
                  y2="3"
                /></svg>
                ä¸‹è½½äºŒç»´ç  (PNG)
              </button>
            </div>

            <div class="text-center mt-4 text-xs text-slate-400">
              å¯¼å‡ºçš„å›¾ç‰‡åˆ†è¾¨ç‡ä¸º:1000x1000px â€¢ çº¯æœ¬åœ°ç”Ÿæˆ
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, watch, onMounted, nextTick } from 'vue'
import QRCode from 'qrcode'
import { saveAs } from 'file-saver'

// ---------------- çŠ¶æ€ç®¡ç† ----------------
const config = reactive({
  text: 'https://github.com',
  darkColor: '#000000',
  lightColor: '#ffffff',
  errorLevel: 'H', // é»˜è®¤é«˜å®¹é”™ï¼Œæ–¹ä¾¿åŠ Logo
  margin: 1,
  logoSize: 20 // ç™¾åˆ†æ¯”
})

const logoUrl = ref('')
const logoInput = ref(null)
const previewUrl = ref('')

// ---------------- é€»è¾‘æ–¹æ³• ----------------

const triggerLogoUpload = () => logoInput.value.click()

const handleLogoChange = (e) => {
  const file = e.target.files[0]
  if (!file) return
  const reader = new FileReader()
  reader.onload = (evt) => {
    logoUrl.value = evt.target.result
  }
  reader.readAsDataURL(file)
}

const removeLogo = () => {
  logoUrl.value = ''
  // å¦‚æœä¸å¼ºåˆ¶ç½®ç©º valueï¼Œä¸‹æ¬¡é€‰åŒæ–‡ä»¶ä¸ä¼šè§¦å‘ change
  if (logoInput.value) logoInput.value.value = ''
}

// æ ¸å¿ƒç”Ÿæˆé€»è¾‘
const generateQR = async () => {
  if (!config.text) return

  // 1. åˆ›å»ºä¸€ä¸ªå†…å­˜ä¸­çš„è™šæ‹Ÿ Canvas (ä¸æ”¾åœ¨ DOM é‡Œ)
  const canvas = document.createElement('canvas')
  const size = 1000 // è®¾å®šé«˜æ¸…åˆ†è¾¨ç‡

  try {
    // 2. åœ¨è™šæ‹Ÿ Canvas ä¸Šç»˜åˆ¶åŸºç¡€äºŒç»´ç 
    await QRCode.toCanvas(canvas, config.text, {
      width: size,
      margin: config.margin,
      color: {
        dark: config.darkColor,
        light: config.lightColor
      },
      errorCorrectionLevel: config.errorLevel
    })

    // 3. å¦‚æœæœ‰ Logoï¼Œç»˜åˆ¶ Logo
    if (logoUrl.value) {
      const ctx = canvas.getContext('2d')
      const img = new Image()
      img.src = logoUrl.value

      await new Promise((resolve) => {
        img.onload = () => {
          const logoSizePx = size * (config.logoSize / 100)
          const x = (size - logoSizePx) / 2
          const y = (size - logoSizePx) / 2

          // ç»˜åˆ¶åœ†è§’èƒŒæ™¯
          ctx.fillStyle = config.lightColor
          ctx.beginPath()
          const bgSize = logoSizePx + 40 // ç™½è¾¹ç¨å¾®å¤§ä¸€ç‚¹
          const bgX = (size - bgSize) / 2
          const bgY = (size - bgSize) / 2
          ctx.roundRect(bgX, bgY, bgSize, bgSize, 40)
          ctx.fill()

          // ç»˜åˆ¶ Logo
          ctx.drawImage(img, x, y, logoSizePx, logoSizePx)
          resolve()
        }
        // é˜²æ­¢å›¾ç‰‡åŠ è½½å¤±è´¥å¡æ­»
        img.onerror = resolve
      })
    }

    // 4. ã€å…³é”®æ­¥éª¤ã€‘ï¼šå°† Canvas è½¬ä¸ºå›¾ç‰‡ URL èµ‹å€¼ç»™ previewUrl
    previewUrl.value = canvas.toDataURL('image/png')
  } catch (err) {
    console.error(err)
  }
}
const download = () => {
  if (!previewUrl.value) return
  // ç›´æ¥ä¿å­˜ previewUrl é‡Œçš„ Base64 æ•°æ®å³å¯
  saveAs(previewUrl.value, `qrcode_${Date.now()}.png`)
}

// ---------------- ç›‘å¬å˜åŒ– ----------------
// ç›‘å¬æ‰€æœ‰é…ç½®å˜åŠ¨ï¼Œè‡ªåŠ¨é‡ç»˜
watch([config, logoUrl], () => {
  // é˜²æŠ–æˆ– nextTick
  nextTick(generateQR)
}, { deep: true })

onMounted(() => {
  generateQR()
})
</script>

<style scoped>
@keyframes blob {
  0% { transform: translate(0, 0) scale(1); }
  33% { transform: translate(30px, -50px) scale(1.1); }
  66% { transform: translate(-20px, 20px) scale(0.9); }
  100% { transform: translate(0, 0) scale(1); }
}
.animate-blob {
  animation: blob 7s infinite;
}
.animation-delay-2000 {
  animation-delay: 2s;
}
.animation-delay-4000 {
  animation-delay: 4s;
}
</style>
